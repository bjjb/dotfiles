#!/usr/bin/env ruby

require 'uri'
require 'open-uri'
require 'nokogiri'
require 'highline/import'
require 'pp'

ARGV.each do |arg|
  q = URI.encode(arg)
  html = open('https://tpb.uri.gy/search/%s/0/99/0' % [q]).read
  doc = Nokogiri::HTML(html)
  links = doc.css('.detLink')
  input = ''
  while input !~ /^(\d+|q)$/i
    links.each_with_index do |link, i|
      puts '[% 2d] %s' % [i + 1, link.text]
    end
    input = ask('Choose (1-%s) or (q)uit > ' % [links.length])
  end
  if input == 'q'
    puts 'OK, goodbye.'
    exit
  else
    i = Integer(input)
    link = doc.css('a[href^="magnet"]')[i - 1]
    system('open "%s"' % link[:href])
    puts "Magnet link should open in the background."
  end
end
